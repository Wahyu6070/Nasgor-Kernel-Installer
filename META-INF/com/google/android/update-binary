#!/sbin/sh
# Nasgor Kernel Installer 1.0
# by wahyu6070 (dont change)

OUTFD=/proc/self/fd/$2;
ZIPFILE="$3";

ps | grep zygote | grep -v grep >/dev/null && BOOTMODE=true || BOOTMODE=false;
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -v grep >/dev/null && BOOTMODE=true;
test $BOOTMODE && OUTFD=/proc/self/fd/0;

ui_print() { $BOOTMODE && echo "$1" || echo -e "ui_print $1\nui_print" >> $OUTFD; }
show_progress() { echo "progress $1 $2" > $OUTFD; }
set_progress() { echo "set_progress $1" > $OUTFD; }
print() { $BOOTMODE && echo "$1" || echo -e "ui_print $1\nui_print" >> $OUTFD; }
getp() { grep "^$1" "$2" | head -n1 | cut -d = -f 2; }
del() { rm -rf "$1"; }
set_perm() {
  chmod $3 $4
  chown $1:$2 $4
}

abort() { print "$1"; exit 1; }
	
#(dont change)
print " ";
print "   Nasgor Kernel Installer by wahyu6070";
print " "
show_progress 1.34 0;

print " ";
print "- Mounting";
mount -o ro /system;
mount /data;
mount /cache;
test -f /system/system/build.prop && root=/system;
set_progress 0.4;

mkdir -p /tmp/nki;
cd /tmp/nki;
print "- Extracting ZIP File"
unzip -o "$ZIPFILE" >&2
module=./module.prop
name=`getp name $module`
version=`getp version $module`
device=`getp device $module`
date=`getp date $module`
author=`getp author $module`
block=`getp block $module`
set_progress 0.5;

#load script
set_perm 0 0 0777 install.sh;
set_perm 0 0 0777 ./bin/magiskboot;
[ -f ./install.sh ] && . ./install.sh;

sdk=$(getp ro.build.version.sdk /system/build.prop)
minsdk=$(getp minsdk $module)
[ $sdk -lt $minsdk ] && abort "- Your Android Version Not Support !!!"

print "- Installing Kernel"
for i in kernel zImage zImage-dtb Image.lzma-dtb Image.xz-dtb Image.gz-dtb; do
    if [ -f $i ]; then
      kernel=$i;
      magiskpatch=true
      break;
    fi;
    done;
    
[ -f bin/magiskboot ] && magiskboot=./bin/magiskboot || abort "- magiskboot not found"
if [ -f boot.img ]; then
$magiskboot unpack boot.img
del kernel_dtb
del *ramdisk*
kernel=kernel
fi
set_progress 0.4;

if [ -f $kernel ]; then
datanki=/data/nki
mv $kernel nasgor-kernel
del $datanki
mkdir -p $datanki
dd if=$block of=$datanki/boot.img
$magiskboot unpack $datanki/boot.img
cat $datanki/boot.img > $datanki/boot.backub.img
del kernel
else
abort "- Kernel or boot.img not found"
fi
set_progress 0.4;

if [ -f nasgor-kernel ]; then
mv nasgor-kernel kernel
[ $magiskpatch ] && print "patching magisk" && $magiskboot hexpatch kernel 736B69705F696E697472616D667300 77616E745F696E697472616D667300
$magiskboot repack $datanki/boot.img
fi
[ -f new-boot.img ] && dd if=new-boot.img of=$block
del $datanki/boot.img
set_progress 0.4;

if [ -d /data/adb/modules ]; then
print "- Magisk Detected";
print "- Building $name in magisk module";
modnki=/data/adb/modules_update/nki;
mkdir -p $modnki;
mkdir -p /data/adb/modules/nki
touch /data/adb/modules/nki/update
cp -pf $module /data/adb/modules/nki/;
cp -pf $module $modnki;
touch $modnki/uninstall.sh;
printf "dd if=/data/nki/boot.backub.img of=$block" > $modnki/uninstall.sh
sed -i "$ a rm -rf /data/nki" $modnki/uninstall.sh
sed -i "$ a reboot" $modnki/uninstall.sh
set_perm_recursive 0 0 0755 0755 $nki;
fi
print "- Unmounting";
umount /system;
umount /data;
umount /cache;
set_progress 1.1;
cd /;
del /tmp/nki;
print "- Installing $name done";
set_progress 0.3;
exit 0;

